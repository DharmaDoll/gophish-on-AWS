# Gophish on AWS 運用戦略：コストと保守しやすさの比較

このドキュメントでは、Gophish on AWS環境を運用する際のコストと保守しやすさのバランスについて、EC2インスタンスの「停止」とTerraformによる「デストロイ」の2つの主要な戦略を比較します。また、特定のリソース（EFSなど）のみをデストロイせずにデータを保持する方法についても説明します。

## 1. 運用戦略の比較

| 項目             | EC2インスタンスの停止 (Stop)                               | Terraformによるデストロイ (Destroy) + 再構築 (Rebuild) |
| :--------------- | :------------------------------------------------------- | :--------------------------------------------------- |
| **月額コスト**   | EC2インスタンス自体の課金は停止するが、EBS、EFS、VPCエンドポイント、Route 53ホストゾーンの料金は発生し続ける。**約 3,500円程度** (VPCエンドポイントが主な要因)。 | すべてのリソースが削除されるため、**ほぼ0円** (ドメイン登録費用を除く)。 |
| **再開の手間**   | **非常に低い**。停止した状態からすぐに再開でき、Gophishのデータや設定はそのまま残る。`terraform apply` を再度実行する必要はない。 | **高い**。`terraform apply` を再度実行する必要があり、`README.md` の「フェーズ3：初回サーバー設定」に記載されている**手動での設定作業（EFSマウント、Certbot実行、Gophish起動、パスワード取得、cron設定など）を毎回やり直す必要がある**。 |
| **データ保持**   | EBSとEFSに保存されたデータは完全に保持される。             | EFSをデストロイしない限りデータは保持されるが、再構築時にEFSを正しくマウントし直す必要がある。 |
| **推奨される頻度** | 短期間の停止 (数日〜数週間) に適している。                 | 長期間の停止 (数ヶ月〜年単位) に適している。         |

## 2. 各運用戦略の詳細

### 2.1. EC2インスタンスの停止 (Stop)

*   **メリット:**
    *   インスタンスの起動・停止が迅速に行えるため、Gophishを必要な時にすぐに使える状態に保てます。
    *   再開時の手動設定がほとんど不要です。
    *   EC2インスタンス自体の課金は停止するため、稼働コストを削減できます。
*   **デメリット:**
    *   EC2にアタッチされているEBSボリュームのストレージ料金は発生し続けます。
    *   EFSのストレージ料金は発生し続けます。
    *   VPCエンドポイントの時間課金は発生し続けます（このプロジェクトでは約3,285円/月）。
    *   インスタンス再開時にパブリックIPアドレスが変更される可能性があり、その場合、DNSレコードの更新が必要になる場合があります。
*   **推奨:** Gophishを比較的頻繁に利用するが、常時稼働させる必要はない場合に最適です。

### 2.2. Terraformによるデストロイ (Destroy) + 再構築 (Rebuild)

*   **メリット:**
    *   すべてのAWSリソースが削除されるため、コストをほぼゼロにできます（ドメイン登録費用を除く）。
    *   環境を完全にクリーンな状態から再構築できます。
*   **デメリット:**
    *   再構築に時間がかかり、多くの手動設定作業を毎回行う必要があります。
    *   Gophishのデータ（EFSに保存されているもの）を保持したい場合、EFSをデストロイしないように注意が必要です。
*   **推奨:** Gophishを長期間（数ヶ月以上）利用しない場合や、環境を完全にリセットしたい場合に適しています。

## 3. 特定リソース（EFS）のみをデストロイせずにデータを保持する方法

Gophishのデータを保持するためにEFSリソースのみを削除せずに、他のリソースをデストロイしたい場合は、以下の方法が最も推奨されます。

### 3.1. `terraform destroy -target` コマンドを使用する

`terraform destroy` コマンドに `-target` オプションの否定形 (`!`) を使用することで、特定のリソースを削除対象から除外できます。これにより、Gophishのデータを保持するEFSだけでなく、**ドメイン登録も保持したまま、他のリソースをデストロイすることが可能**です。

```bash
# EFSファイルシステムとマウントターゲット、およびドメイン登録以外のすべてのリソースを削除する例
# プロジェクトの `terraform` ディレクトリで実行します
cd terraform
terraform destroy -target="!aws_efs_file_system.main" -target="!aws_efs_mount_target.main" -target="!aws_route53domains_registered_domain.main"
```

*   `!aws_efs_file_system.main`: EFSファイルシステムリソースを削除対象から除外します。
*   `!aws_efs_mount_target.main`: EFSマウントターゲットリソースを削除対象から除外します。
*   `!aws_route53domains_registered_domain.main`: Route 53のドメイン登録リソースを削除対象から除外します。

このコマンドを実行すると、EFS上のデータとドメイン登録は保持されたまま、他のすべてのリソースが削除されます。再構築時には、既存のEFSとドメイン登録をTerraformが認識し、新しいインフラを構築します。

### 3.2. `terraform state rm` を使用する (非推奨)

この方法は、EFSリソースをTerraformの管理下から外すことで、`terraform destroy` 実行時に削除されないようにする方法です。しかし、**リソースがTerraformの管理外になるため、以降の管理が複雑になる**ため、通常は推奨されません。

```bash
# EFSファイルシステムをTerraformのStateから削除する例
# プロジェクトの `terraform` ディレクトリで実行します
cd terraform
terraform state rm aws_efs_file_system.main
terraform state rm aws_efs_mount_target.main
```

*   このコマンドを実行した後、`terraform destroy` を実行してもEFSは削除されません。
*   しかし、EFSリソースはTerraformの管理外になるため、手動で管理するか、将来的に再度Terraformの管理下に戻す必要があります。

## 4. まとめ

Gophish on AWSの運用では、利用頻度に応じてEC2インスタンスの停止とTerraformデストロイを使い分けることが、コストと保守しやすさのバランスを取る上で重要です。特にEFSのデータを保持したい場合は、`terraform destroy -target` オプションの活用を検討してください。
